name: Publish package to Google Artifact Registry

on:
  push:
    tags:
      - 'v*'            # 例: v1.0.0, v1.2.3 だけで発火
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read        # Checkout に必要
  id-token: write       # google-github-actions/auth@v2 に必要

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) ソース取得 ― 履歴とタグをすべて持ってくる
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags:  true

      # 2) Python セットアップ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 3) ビルドに必要なツールのみインストール
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine \
                               keyring \
                               keyrings.google-artifactregistry-auth

      # 4) パッケージをビルド
      - name: Build wheel & sdist
        run: python -m build --sdist --wheel --outdir dist/

      # 5) Google Cloud 認証
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 6) gcloud CLI を入れる（キーリング連携で必要）
      - name: Install gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # 7) Artifact Registry へアップロード
      - name: Upload to Artifact Registry
        env:
          TWINE_NON_INTERACTIVE: "1"
          REPO_URL: https://${{ vars.GAR_REGION }}-python.pkg.dev/${{ vars.GAR_PROJECT }}/${{ vars.GAR_REPOSITORY }}/
        run: python -m twine upload --repository-url "$REPO_URL" dist/*
